# ワークフローの名前
name: Release

# ワークフローが実行されるトリガーを指定
on:
  push:
    # 'v'で始まるタグ（例: v1.0, v1.2.3）がプッシュされた時のみ実行
    tags:
      - 'v*'

# 実行される一連のジョブを定義
jobs:
  # 'build-and-release' という名前の単一ジョブを定義
  build-and-release:
    # すべてのビルドを単一のUbuntuランナーで実行
    runs-on: ubuntu-latest

    # ジョブ内の一連のステップを定義
    steps:
      # ステップ1: リポジトリのコードをチェックアウトする
      - name: Checkout code
        uses: actions/checkout@v4

      # ステップ2: Rustのツールチェーンをセットアップする
      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      # ステップ3: Windowsターゲットをインストール
      # crossがフォールバックした際にホスト上でビルドするために必要
      - name: Install windows target
        run: rustup target add x86_64-pc-windows-msvc

      # ステップ4: Cargoのビルドキャッシュを設定する
      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      # ステップ5: クロスコンパイルツール 'cross' をインストール
      # crates.io から特定のバージョンをインストールする
      - name: Install cross
        run: cargo install cross --version 0.2.5

      # ステップ6: Linux と Windows 向けにビルド
      # crossコマンドがターゲットに合ったDockerイメージを自動で利用する
      - name: Build for all targets
        run: |
          cross build --release --target x86_64-unknown-linux-gnu
          cross build --release --target x86_64-pc-windows-msvc

      # ステップ7: リリース用のアセットを準備する
      # 各ターゲットの実行ファイルを個別にzipアーカイブする
      - name: Prepare release assets
        shell: bash
        run: |
          set -e # エラーが発生したら即座にスクリプトを終了する
          
          PROJECT_NAME=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].name')
          
          # Linux用アセットの準備
          LINUX_TARGET="x86_64-unknown-linux-gnu"
          LINUX_EXECUTABLE_PATH="target/${LINUX_TARGET}/release/${PROJECT_NAME}"
          LINUX_ARCHIVE_NAME="${PROJECT_NAME}-${{ github.ref_name }}-linux-x64.zip"
          zip "${LINUX_ARCHIVE_NAME}" "${LINUX_EXECUTABLE_PATH}"
          
          # Windows用アセットの準備
          WINDOWS_TARGET="x86_64-pc-windows-msvc"
          WINDOWS_EXECUTABLE_PATH="target/${WINDOWS_TARGET}/release/${PROJECT_NAME}.exe"
          WINDOWS_ARCHIVE_NAME="${PROJECT_NAME}-${{ github.ref_name }}-windows-x64.zip"
          zip "${WINDOWS_ARCHIVE_NAME}" "${WINDOWS_EXECUTABLE_PATH}"
          
          # 後続のステップで使えるようにアーカイブ名を環境変数に設定
          echo "LINUX_ARCHIVE=${LINUX_ARCHIVE_NAME}" >> $GITHUB_ENV
          echo "WINDOWS_ARCHIVE=${WINDOWS_ARCHIVE_NAME}" >> $GITHUB_ENV

      # ステップ8: GitHub Releaseを作成し、zipファイルをアップロードする
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          # 前のステップで作成した両方のzipファイルをアップロード
          files: |
            ${{ env.LINUX_ARCHIVE }}
            ${{ env.WINDOWS_ARCHIVE }}
